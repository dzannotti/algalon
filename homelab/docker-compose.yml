# Algalon Homelab Stack
# Complete media server, NAS, VPN, and automation setup
#
# Prerequisites:
# 1. Create data directory: sudo mkdir -p /data/{media/{movies,tv,music},downloads/{complete,incomplete},sync,private,public}
# 2. Set ownership: sudo chown -R $USER:$USER /data
# 3. Copy .env.example to .env and fill in your values
# 4. Run: docker-compose up -d
#
# Access after Pi-hole DNS is configured (point router DNS to algalon IP):
# - jellyfin.algalon.local - Media streaming
# - jellyseerr.algalon.local - Request movies/shows
# - radarr.algalon.local, sonarr.algalon.local, etc.
# - pihole.algalon.local - Ad blocking admin

networks:
  servarrnetwork:
    name: servarrnetwork
    driver: bridge
    ipam:
      config:
        - subnet: 172.39.0.0/24

services:
  # ============================================================================
  # VPN & NETWORKING
  # ============================================================================

  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.2
    ports:
      - 8000:8000 # gluetun control server
      - 8080:8080 # qbittorrent
      - 6881:6881 # qbittorrent torrent port
      - 6881:6881/udp
      - 6789:6789 # nzbget
      - 9696:9696 # prowlarr
    volumes:
      - ./gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=expressvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${EXPRESSVPN_USER}
      - OPENVPN_PASSWORD=${EXPRESSVPN_PASSWORD}
      - SERVER_COUNTRIES=${EXPRESSVPN_COUNTRY}
      - FIREWALL_VPN_INPUT_PORTS=${FIREWALL_VPN_INPUT_PORTS}
      - HTTPPROXY=on
      - HTTPPROXY_LISTENING_ADDRESS=:8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - TZ=${TZ}
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 20s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    environment:
      - TZ=${TZ}
      - WEBPASSWORD=${PIHOLE_PASSWORD}
      - PIHOLE_DNS_=1.1.1.1;1.0.0.1 # Cloudflare DNS
      - DNSMASQ_LISTENING=all
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - 53:53/tcp
      - 53:53/udp
      - 8082:80 # Pi-hole web interface
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.15
    dns:
      - 127.0.0.1
      - 1.1.1.1
    restart: unless-stopped

  caddy:
    image: caddy:latest
    container_name: caddy
    network_mode: host
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy_data:/data
      - ./caddy_config:/config
    restart: unless-stopped

  # ============================================================================
  # DOWNLOAD CLIENTS (Through VPN)
  # ============================================================================

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    labels:
      - deunhealth.restart.on.unhealthy=true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
      - TORRENTING_PORT=${FIREWALL_VPN_INPUT_PORTS}
    volumes:
      - ./qbittorrent:/config
      - /data:/data
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    network_mode: service:gluetun
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 60s
      retries: 3
      start_period: 20s
      timeout: 10s
    restart: unless-stopped

  deunhealth:
    image: qmcgaw/deunhealth
    container_name: deunhealth
    network_mode: "none"
    environment:
      - LOG_LEVEL=info
      - HEALTH_SERVER_ADDRESS=127.0.0.1:9999
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: always

  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: nzbget
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./nzbget:/config
      - /data:/data
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    network_mode: service:gluetun
    restart: unless-stopped

  # ============================================================================
  # INDEXERS (Through VPN)
  # ============================================================================

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./prowlarr:/config
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    network_mode: service:gluetun
    restart: unless-stopped

  # ============================================================================
  # MEDIA MANAGEMENT (*ARR STACK)
  # ============================================================================

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./sonarr:/config
      - /data:/data
    ports:
      - 8989:8989
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.3
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./radarr:/config
      - /data:/data
    ports:
      - 7878:7878
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.4
    restart: unless-stopped

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./lidarr:/config
      - /data:/data
    ports:
      - 8686:8686
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.5
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./bazarr:/config
      - /data:/data
    ports:
      - 6767:6767
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.6
    restart: unless-stopped

  # ============================================================================
  # MEDIA STREAMING
  # ============================================================================

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./jellyfin/config:/config
      - ./jellyfin/cache:/cache
      - /data/media:/media:ro
    ports:
      - 8096:8096
      - 8920:8920 # HTTPS
      - 7359:7359/udp # Service discovery
      - 1900:1900/udp # Service discovery
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.10
    restart: unless-stopped

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
    volumes:
      - ./jellyseerr:/app/config
    ports:
      - 5055:5055
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.9
    restart: unless-stopped

  # ============================================================================
  # FILE SYNC & NAS
  # ============================================================================

  # syncthing:
  #   image: lscr.io/linuxserver/syncthing:latest
  #   container_name: syncthing
  #   hostname: algalon
  #   environment:
  #     - PUID=${PUID}
  #     - PGID=${PGID}
  #     - TZ=${TZ}
  #   volumes:
  #     - ./syncthing:/config
  #     - /data/sync:/sync
  #   ports:
  #     - 8384:8384 # Web UI
  #     - 22000:22000/tcp # Sync protocol
  #     - 22000:22000/udp
  #     - 21027:21027/udp # Discovery
  #   networks:
  #     servarrnetwork:
  #       ipv4_address: 172.39.0.11
  #   restart: unless-stopped

  samba:
    image: dperson/samba:latest
    container_name: samba
    environment:
      - TZ=${TZ}
      - USERID=${PUID}
      - GROUPID=${PGID}
    ports:
      - 139:139
      - 445:445
    volumes:
      - /data/media:/media
      - /data/private:/private
      - /data/public:/public
      - /data/downloads:/downloads
    command: >
      -u "${SAMBA_USER};${SAMBA_PASSWORD};${PUID}"
      -s "media;/media;yes;no;no;${SAMBA_USER};${SAMBA_USER};${SAMBA_USER};Media Library"
      -s "downloads;/downloads;yes;no;no;${SAMBA_USER};${SAMBA_USER};${SAMBA_USER};Downloads"
      -s "private;/private;yes;no;no;${SAMBA_USER};${SAMBA_USER};${SAMBA_USER};Private Files"
      -s "public;/public;yes;no;yes;all;all;all;Public Share"
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.13
    restart: unless-stopped

  # ============================================================================
  # UTILITIES
  # ============================================================================

  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    command: serve
    environment:
      - TZ=${TZ}
    volumes:
      - ./ntfy:/var/cache/ntfy
    ports:
      - 8585:80
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.12
    restart: unless-stopped
